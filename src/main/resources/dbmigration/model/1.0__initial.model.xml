<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<migration xmlns="http://ebean-orm.github.io/xml/ns/dbmigration">
    <changeSet type="apply">
        <createTable name="audit_log" pkName="pk_audit_log">
            <column name="id" type="bigint" primaryKey="true"/>
            <column name="tenant_id" type="bigint" notnull="true"/>
            <column name="entity_name" type="varchar" notnull="true"/>
            <column name="unique_identifier" type="varchar" notnull="true"/>
            <column name="action" type="varchar(8)" notnull="true" checkConstraint="check ( action in ('CREATE','UPDATE','PATCH','DELETE','MIGRATE','RE_INDEX'))" checkConstraintName="ck_audit_log_action"/>
            <column name="user_id" type="varchar" notnull="true"/>
            <column name="client_ip" type="varchar" notnull="true"/>
            <column name="created_at" type="timestamp" notnull="true"/>
            <column name="old_data" type="jsonb"/>
            <column name="new_data" type="jsonb"/>
            <column name="notes" type="varchar"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
        </createTable>
        <createTable name="data_model" pkName="pk_data_model">
            <column name="id" type="bigint" primaryKey="true"/>
            <column name="tenant_id" type="bigint" notnull="true"/>
            <column name="schema_id" type="bigint" notnull="true" references="schema_model.id" foreignKeyName="fk_data_model_schema_id" foreignKeyIndex="ix_data_model_schema_id"/>
            <column name="data" type="jsonb" notnull="true"/>
            <column name="unique_identifier" type="varchar" notnull="true"/>
            <column name="entity_name" type="varchar" notnull="true"/>
            <column name="version_name" type="varchar" notnull="true"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
            <uniqueConstraint name="uq_data_model_unique_identifier_entity_name_version_name__1" columnNames="unique_identifier,entity_name,version_name,tenant_id" oneToOne="false" nullableColumns=""/>
        </createTable>
        <createTable name="data_search_model" pkName="pk_data_search_model">
            <column name="id" type="bigint" primaryKey="true"/>
            <column name="tenant_id" type="bigint" notnull="true"/>
            <column name="entity_name" type="varchar" notnull="true"/>
            <column name="unique_identifier" type="varchar" notnull="true"/>
            <column name="json_path" type="varchar" notnull="true"/>
            <column name="value" type="jsonb" notnull="true"/>
            <column name="value_type" type="varchar(7)" notnull="true" checkConstraint="check ( value_type in ('STRING','NUMBER','BOOLEAN','OBJECT','ARRAY','NULL'))" checkConstraintName="ck_data_search_model_value_type"/>
            <column name="array_idx" type="integer"/>
            <column name="data_created_at" type="timestamp"/>
            <column name="data_modified_at" type="timestamp"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
        </createTable>
        <createTable name="report_execution_log" pkName="pk_report_execution_log">
            <column name="id" type="bigint" primaryKey="true"/>
            <column name="tenant_id" type="bigint" notnull="true"/>
            <column name="job_id" type="varchar"/>
            <column name="report_id" type="bigint" notnull="true" references="report_model.id" foreignKeyName="fk_report_execution_log_report_id"/>
            <column name="status" type="varchar(9)" notnull="true" checkConstraint="check ( status in ('PENDING','RUNNING','COMPLETED','FAILED','CANCELLED'))" checkConstraintName="ck_report_execution_log_status"/>
            <column name="execution_type" type="varchar(11)" checkConstraint="check ( execution_type in ('MANUAL','SCHEDULED','API_REQUEST'))" checkConstraintName="ck_report_execution_log_execution_type"/>
            <column name="started_at" type="timestamp"/>
            <column name="completed_at" type="timestamp"/>
            <column name="execution_time_ms" type="bigint"/>
            <column name="error_message" type="TEXT"/>
            <column name="row_count" type="integer"/>
            <column name="local_file_path" type="varchar"/>
            <column name="s3_bucket_name" type="varchar"/>
            <column name="s3_object_key" type="varchar"/>
            <column name="file_size_bytes" type="bigint"/>
            <column name="file_format" type="varchar(4)" notnull="true" checkConstraint="check ( file_format in ('CSV','JSON','XLS','XLSX'))" checkConstraintName="ck_report_execution_log_file_format"/>
            <column name="storage_location" type="varchar(5)" notnull="true" checkConstraint="check ( storage_location in ('NONE','LOCAL','S3','BOTH'))" checkConstraintName="ck_report_execution_log_storage_location"/>
            <column name="execution_metadata" type="json" notnull="true"/>
            <column name="requested_by" type="varchar"/>
            <column name="scheduler_job_id" type="varchar"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
            <uniqueConstraint name="report_execution_job_id_idx" columnNames="job_id" oneToOne="false" nullableColumns="job_id"/>
        </createTable>
        <createTable name="report_model" pkName="pk_report_model">
            <column name="id" type="bigint" primaryKey="true"/>
            <column name="tenant_id" type="bigint" notnull="true"/>
            <column name="name" type="varchar" notnull="true"/>
            <column name="sql" type="TEXT" notnull="true"/>
            <column name="execution_type" type="varchar(9)" notnull="true" checkConstraint="check ( execution_type in ('ADHOC','SCHEDULED','BOTH'))" checkConstraintName="ck_report_model_execution_type"/>
            <column name="cron_schedule" type="varchar"/>
            <column name="completion_actions" type="jsonb" notnull="true"/>
            <column name="is_active" type="boolean" defaultValue="false" notnull="true"/>
            <column name="file_format" type="varchar(4)" notnull="true" checkConstraint="check ( file_format in ('CSV','JSON','XLS','XLSX'))" checkConstraintName="ck_report_model_file_format"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
            <uniqueConstraint name="report_name_idx" columnNames="name,tenant_id" oneToOne="false" nullableColumns=""/>
        </createTable>
        <createTable name="schema_model" pkName="pk_schema_model">
            <column name="id" type="bigint" primaryKey="true"/>
            <column name="tenant_id" type="bigint" notnull="true"/>
            <column name="entity_name" type="varchar" notnull="true"/>
            <column name="json_schema" type="jsonb" notnull="true"/>
            <column name="version_name" type="varchar" notnull="true"/>
            <column name="unique_identifier_formatter" type="varchar" notnull="true"/>
            <column name="indexed_json_paths" type="jsonb" notnull="true"/>
            <column name="lifecycle_scripts" type="jsonb" notnull="true"/>
            <column name="is_validation_enabled" type="boolean" defaultValue="false" notnull="true"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
            <uniqueConstraint name="uq_schema_model_entity_name_version_name_tenant_id" columnNames="entity_name,version_name,tenant_id" oneToOne="false" nullableColumns=""/>
        </createTable>
        <createTable name="tenant_model" pkName="pk_tenant_model">
            <column name="id" type="bigint" primaryKey="true"/>
            <column name="name" type="varchar" notnull="true"/>
            <column name="domain" type="varchar" notnull="true"/>
            <column name="description" type="varchar"/>
            <column name="is_active" type="boolean" defaultValue="false" notnull="true"/>
            <column name="settings" type="jsonb" notnull="true"/>
            <column name="config" type="jsonb" notnull="true"/>
            <column name="allowed_ips" type="jsonb"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
            <uniqueConstraint name="uq_tenant_model_domain" columnNames="domain" oneToOne="false" nullableColumns=""/>
        </createTable>
        <createIndex indexName="ix_audit_log_tenant_id_entity_name_action_created_at_uniq_1" tableName="audit_log" columns="tenant_id,entity_name,action,created_at,unique_identifier,user_id"/>
        <createIndex indexName="ix_audit_log_tenant_id" tableName="audit_log" columns="tenant_id"/>
        <createIndex indexName="ix_data_model_data" tableName="data_model" columns="data" definition="CREATE INDEX search_gin_data ON data_model USING GIN(data jsonb_path_ops)"/>
        <createIndex indexName="ix_data_model_tenant_id" tableName="data_model" columns="tenant_id"/>
        <createIndex indexName="search_value_numeric" tableName="data_search_model" columns="" definition="CREATE INDEX search_value_numeric ON data_search_model USING BTREE (((value-&gt;'value')::numeric)) where value_type = 'NUMBER'"/>
        <createIndex indexName="search_value_text" tableName="data_search_model" columns="" definition="CREATE INDEX search_value_text ON data_search_model USING BTREE ((value-&gt;&gt;'value')) where value_type = 'STRING'"/>
        <createIndex indexName="search_value_boolean" tableName="data_search_model" columns="" definition="CREATE INDEX search_value_text ON data_search_model USING BTREE (((value-&gt;'value')::boolean)) where value_type = 'BOOLEAN'"/>
        <createIndex indexName="search_value_gin" tableName="data_search_model" columns="" definition="CREATE INDEX search_value_gin ON data_search_model USING GIN((value-&gt;'value') jsonb_path_ops)"/>
        <createIndex indexName="search_gin" tableName="data_search_model" columns="" definition="CREATE INDEX search_gin ON data_search_model USING GIN(value jsonb_path_ops)"/>
        <createIndex indexName="ix_data_search_model_tenant_id" tableName="data_search_model" columns="tenant_id"/>
        <createIndex indexName="ix_data_search_model_entity_name" tableName="data_search_model" columns="entity_name"/>
        <createIndex indexName="report_execution_report_id_idx" tableName="report_execution_log" columns="report_id"/>
        <createIndex indexName="report_execution_status_idx" tableName="report_execution_log" columns="status,storage_location"/>
        <createIndex indexName="ix_report_execution_log_tenant_id" tableName="report_execution_log" columns="tenant_id"/>
        <createIndex indexName="ix_report_model_tenant_id" tableName="report_model" columns="tenant_id"/>
        <createIndex indexName="ix_schema_model_tenant_id" tableName="schema_model" columns="tenant_id"/>
    </changeSet>
</migration>