<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<migration xmlns="http://ebean-orm.github.io/xml/ns/dbmigration">
    <changeSet type="apply">
        <createTable name="application_model" identityType="external" pkName="pk_application_model">
            <column name="id" type="uuid" primaryKey="true" identity="true"/>
            <column name="tenant_id" type="uuid" notnull="true" references="tenant_model.id" foreignKeyName="fk_application_model_tenant_id" foreignKeyIndex="ix_application_model_tenant_id"/>
            <column name="application_name" type="varchar" notnull="true"/>
            <column name="description" type="varchar"/>
            <column name="is_active" type="boolean" defaultValue="false" notnull="true"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
            <uniqueConstraint name="uq_application_model_application_name_tenant_id" columnNames="application_name,tenant_id" oneToOne="false" nullableColumns=""/>
        </createTable>
        <createTable name="audit_log" identityType="external" pkName="pk_audit_log">
            <column name="id" type="uuid" primaryKey="true" identity="true"/>
            <column name="tenant_id" type="uuid" notnull="true" references="tenant_model.id" foreignKeyName="fk_audit_log_tenant_id" foreignKeyIndex="ix_audit_log_tenant_id"/>
            <column name="entity_name" type="varchar(255)" notnull="true"/>
            <column name="unique_identifier" type="varchar(255)" notnull="true"/>
            <column name="action" type="varchar(255)" notnull="true" checkConstraint="check ( action in ('CREATE','UPDATE','PATCH','DELETE','MIGRATE','RE_INDEX'))" checkConstraintName="ck_audit_log_action"/>
            <column name="user_id" type="varchar(255)" notnull="true"/>
            <column name="client_ip" type="varchar(255)" notnull="true"/>
            <column name="created_at" type="timestamp(255)" notnull="true"/>
            <column name="old_data" type="jsonb(255)"/>
            <column name="new_data" type="jsonb(255)"/>
            <column name="notes" type="varchar(255)"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
        </createTable>
        <createTable name="data_model" identityType="external" pkName="pk_data_model">
            <column name="id" type="uuid" primaryKey="true" identity="true"/>
            <column name="tenant_id" type="uuid" notnull="true" references="tenant_model.id" foreignKeyName="fk_data_model_tenant_id" foreignKeyIndex="ix_data_model_tenant_id"/>
            <column name="application_id" type="uuid" references="application_model.id" foreignKeyName="fk_data_model_application_id" foreignKeyIndex="ix_data_model_application_id"/>
            <column name="schema_id" type="uuid" notnull="true" references="schema_model.id" foreignKeyName="fk_data_model_schema_id" foreignKeyIndex="ix_data_model_schema_id"/>
            <column name="data" type="jsonb" notnull="true"/>
            <column name="unique_identifier" type="varchar" notnull="true"/>
            <column name="entity_name" type="varchar" notnull="true"/>
            <column name="version_name" type="varchar" notnull="true"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
        </createTable>
        <createTable name="report_execution_log" identityType="external" pkName="pk_report_execution_log">
            <column name="id" type="uuid" primaryKey="true" identity="true"/>
            <column name="tenant_id" type="uuid" notnull="true" references="tenant_model.id" foreignKeyName="fk_report_execution_log_tenant_id" foreignKeyIndex="ix_report_execution_log_tenant_id"/>
            <column name="job_id" type="varchar"/>
            <column name="report_id" type="uuid" notnull="true" references="report_model.id" foreignKeyName="fk_report_execution_log_report_id"/>
            <column name="status" type="varchar(9)" notnull="true" checkConstraint="check ( status in ('PENDING','RUNNING','COMPLETED','FAILED','CANCELLED'))" checkConstraintName="ck_report_execution_log_status"/>
            <column name="execution_type" type="varchar(11)" checkConstraint="check ( execution_type in ('MANUAL','SCHEDULED','API_REQUEST'))" checkConstraintName="ck_report_execution_log_execution_type"/>
            <column name="started_at" type="timestamp"/>
            <column name="completed_at" type="timestamp"/>
            <column name="execution_time_ms" type="bigint"/>
            <column name="error_message" type="TEXT"/>
            <column name="row_count" type="integer"/>
            <column name="local_file_path" type="varchar"/>
            <column name="s3_bucket_name" type="varchar"/>
            <column name="s3_object_key" type="varchar"/>
            <column name="file_size_bytes" type="bigint"/>
            <column name="file_format" type="varchar(4)" notnull="true" checkConstraint="check ( file_format in ('CSV','JSON','XLS','XLSX'))" checkConstraintName="ck_report_execution_log_file_format"/>
            <column name="storage_location" type="varchar(5)" notnull="true" checkConstraint="check ( storage_location in ('NONE','LOCAL','S3','BOTH'))" checkConstraintName="ck_report_execution_log_storage_location"/>
            <column name="execution_metadata" type="json" notnull="true"/>
            <column name="requested_by" type="varchar"/>
            <column name="scheduler_job_id" type="varchar"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
            <uniqueConstraint name="report_execution_job_id_idx" columnNames="job_id" oneToOne="false" nullableColumns="job_id"/>
        </createTable>
        <createTable name="report_model" identityType="external" pkName="pk_report_model">
            <column name="id" type="uuid" primaryKey="true" identity="true"/>
            <column name="tenant_id" type="uuid" notnull="true" references="tenant_model.id" foreignKeyName="fk_report_model_tenant_id" foreignKeyIndex="ix_report_model_tenant_id"/>
            <column name="name" type="varchar(255)" notnull="true"/>
            <column name="sql" type="TEXT" notnull="true"/>
            <column name="execution_type" type="varchar(255)" notnull="true" checkConstraint="check ( execution_type in ('ADHOC','SCHEDULED','BOTH'))" checkConstraintName="ck_report_model_execution_type"/>
            <column name="cron_schedule" type="varchar"/>
            <column name="completion_actions" type="jsonb" notnull="true"/>
            <column name="is_active" type="boolean" defaultValue="false" notnull="true"/>
            <column name="file_format" type="varchar(255)" notnull="true" checkConstraint="check ( file_format in ('CSV','JSON','XLS','XLSX'))" checkConstraintName="ck_report_model_file_format"/>
            <column name="parameters" type="jsonb" notnull="true"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
            <uniqueConstraint name="report_name_idx" columnNames="name,tenant_id" oneToOne="false" nullableColumns=""/>
        </createTable>
        <createTable name="schema_model" identityType="external" pkName="pk_schema_model">
            <column name="id" type="uuid" primaryKey="true" identity="true"/>
            <column name="tenant_id" type="uuid" notnull="true" references="tenant_model.id" foreignKeyName="fk_schema_model_tenant_id" foreignKeyIndex="ix_schema_model_tenant_id"/>
            <column name="application_id" type="uuid" references="application_model.id" foreignKeyName="fk_schema_model_application_id" foreignKeyIndex="ix_schema_model_application_id"/>
            <column name="entity_name" type="varchar" notnull="true"/>
            <column name="json_schema" type="jsonb" notnull="true"/>
            <column name="version_name" type="varchar" notnull="true"/>
            <column name="unique_identifier_formatter" type="varchar" notnull="true"/>
            <column name="indexed_json_paths" type="jsonb" notnull="true"/>
            <column name="lifecycle_scripts" type="jsonb" notnull="true"/>
            <column name="is_validation_enabled" type="boolean" defaultValue="false" notnull="true"/>
            <column name="partition_by" type="varchar(5)" notnull="true" checkConstraint="check ( partition_by in ('YEAR','MONTH'))" checkConstraintName="ck_schema_model_partition_by"/>
            <column name="unique_id" type="varchar" notnull="true"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
            <uniqueConstraint name="uq_schema_model_entity_name_version_name_tenant_id_applic_1" columnNames="entity_name,version_name,tenant_id,application_id" oneToOne="false" nullableColumns="application_id"/>
        </createTable>
        <createTable name="tenant_model" identityType="external" pkName="pk_tenant_model">
            <column name="id" type="uuid" primaryKey="true" identity="true"/>
            <column name="name" type="varchar" notnull="true"/>
            <column name="domain" type="varchar" notnull="true"/>
            <column name="description" type="varchar"/>
            <column name="is_active" type="boolean" defaultValue="false" notnull="true"/>
            <column name="settings" type="jsonb" notnull="true"/>
            <column name="config" type="jsonb" notnull="true"/>
            <column name="allowed_ips" type="jsonb"/>
            <column name="deleted" type="boolean" defaultValue="false" notnull="true"/>
            <column name="version" type="integer" notnull="true"/>
            <column name="when_created" type="timestamp" notnull="true"/>
            <column name="when_modified" type="timestamp" notnull="true"/>
            <column name="who_created" type="varchar" notnull="true"/>
            <column name="who_modified" type="varchar" notnull="true"/>
            <uniqueConstraint name="uq_tenant_model_domain" columnNames="domain" oneToOne="false" nullableColumns=""/>
        </createTable>
        <createIndex indexName="ix_audit_log_tenant_id_entity_name_action_created_at_uniq_1" tableName="audit_log" columns="tenant_id,entity_name,action,created_at,unique_identifier,user_id"/>
        <createIndex indexName="data_model_unique_identifier" tableName="data_model" columns="unique_identifier,tenant_id,application_id,schema_id"/>
        <createIndex indexName="report_execution_report_id_idx" tableName="report_execution_log" columns="report_id"/>
        <createIndex indexName="report_execution_status_idx" tableName="report_execution_log" columns="status,storage_location"/>
    </changeSet>
</migration>